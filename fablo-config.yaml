---
"$schema": https://github.com/hyperledger-labs/fablo/releases/download/1.2.0/schema.json

global:
  fabricVersion: 2.5.4
  tls: true
  engine: docker
  peerDevMode: false

orgs:
  - organization:
      name: Orderer
      domain: orderer.sentinelvote.tech
    orderers:
      - groupName: group1
        type: solo
        instances: 1
    tools:
      fabloRest: true
  - organization:
      name: Voter
      domain: voter.sentinelvote.tech
    ca:
      db: sqlite
    peer:
      instances: 2 # Set a value between 2 (minimum) and 9 (maximum).
      db: LevelDb
    tools:
      fabloRest: true
      explorer: true

channels:
  - name: vote-channel
    orgs:
      - name: Voter
        peers:
          - peer0 # MUST have 'peer0' as the first peer for 'explorer' to work.
          - peer1 # Do not edit, use line 28 to control the number of peers.
          - peer2 # Do not edit, use line 28 to control the number of peers.
          - peer3 # Do not edit, use line 28 to control the number of peers.
          - peer4 # Do not edit, use line 28 to control the number of peers.
          - peer5 # Do not edit, use line 28 to control the number of peers.
          - peer6 # Do not edit, use line 28 to control the number of peers.
          - peer7 # Do not edit, use line 28 to control the number of peers.
          - peer8 # Do not edit, use line 28 to control the number of peers.

chaincodes:
  - name: SentinelVote
    version: 1.0.0
    lang: golang
    channel: vote-channel
    directory: "./chaincode"
    privateData:
      - name: foldedPublicKeys
        orgNames:
          - Voter

hooks :
  postGenerate: "
    printf '\n'
    && printf '%s\n\n' 'Replacing example.com with sentinelvote.tech in docker-compose.yaml ...' 
    &&   set -x 
    &&   sed -i.bak 's/example.com/sentinelvote.tech/g' fablo-target/fabric-docker/docker-compose.yaml  
    &&   rm fablo-target/fabric-docker/docker-compose.yaml.bak 
    &&   set +x >/dev/null 2>&1 
    && printf '\n%s\n' 'Replacing requiredPeerCount in fabric-config/collections/* ...' 
    &&   set -x 
    &&   sed -i.bak '5s/[0-9]/0/g' fablo-target/fabric-config/collections/SentinelVote.json 
    &&   rm fablo-target/fabric-config/collections/SentinelVote.json.bak 
    &&   set +x >/dev/null 2>&1 
    && printf '\n%s\n' 'Replacing blockchain explorer credentials in fablo-target/fabric-config/explorer/connection-profile-voter.json ...' 
    &&   set -x
    &&   DOUBLE_QUOTE=\"
    &&   jq --arg id 'admin@sentinelvote.tech' --arg password 'password' '.client.adminCredential.id = $id | .client.adminCredential.password = $password' fablo-target/fabric-config/explorer/connection-profile-voter.json > tmpfile
    &&   mv -f tmpfile fablo-target/fabric-config/explorer/connection-profile-voter.json
    &&   set +x >/dev/null 2>&1 
    && printf '\n%s\n' 'Increasing max message size [ from (100 * 1024 ** 2) to (500 * 1024 ** 2) ] in bytes that GRPC server and client can receive and send ...'
    &&   set -x
    &&   awk '/CORE_CHAINCODE_BUILDER/ { print; print \"      - CORE_PEER_MAXRECVMSGSIZE=524288000\"; print \"      - CORE_PEER_MAXSENDMSGSIZE=524288000\"; next }1' fablo-target/fabric-docker/docker-compose.yaml > tmpfile
    &&   mv tmpfile fablo-target/fabric-docker/docker-compose.yaml
    &&   set +x >/dev/null 2>&1
    && printf '\n%s\n' 'Creating forked docker image of fablo-rest ...'
    &&   set -x
    &&   _dockerfile=$(./setup-fablo.sh fablo_rest)
    &&   set +x >/dev/null 2>&1
    && printf '\n\n%s\n' 'Building forked docker image of fablo-rest ...'
    &&   set -x
    &&   docker build -t ghcr.io/sentinelvote/fablo-rest:0.1.0 -f $_dockerfile .
    &&   set +x >/dev/null 2>&1
    && printf '\n%s\n' 'Replacing fablo-rest docker image with forked build ...'
    &&   set -x
    &&   sed -i.bak 's|softwaremill/fablo-rest:${FABLO_REST_VERSION}|ghcr.io/sentinelvote/fablo-rest:0.1.0|g' fablo-target/fabric-docker/docker-compose.yaml
    &&   rm fablo-target/fabric-docker/docker-compose.yaml.bak
    &&   set +x >/dev/null 2>&1
    && printf '\nAll Done!\n\n'
  "
